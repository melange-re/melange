
  $ . ./setup.sh
  $ cat > dune-project <<EOF
  > (lang dune 3.8)
  > (using melange 0.1)
  > EOF
  $ cat > dune <<EOF
  > (melange.emit
  >  (target js-out)
  >  (preprocess (pps melange.ppx)))
  > EOF
  $ cat > x.ml << EOF
  > exception A of int
  > let () =
  >   let a0 =
  >     try [%mel.raw{| (function (){throw 2} ()) |}] with
  >     | A x -> x
  >     | Js.Exn.Error v -> Obj.magic v
  >     | _ -> assert false
  >   in
  >   Js.log a0
  > EOF
  $ dune build @melange
  $ cat _build/default/js-out/x.js
  // Generated by Melange
  'use strict';
  
  var Caml_exceptions = require("melange.js/caml_exceptions.js");
  var Caml_js_exceptions = require("melange.js/caml_js_exceptions.js");
  var Js__Js_exn = require("melange.js/js_exn.js");
  
  var A = /* @__PURE__ */Caml_exceptions.create("Melange__X.A");
  
  var a0;
  
  try {
    a0 = ((function (){throw 2} ())
    );
  }
  catch (raw_exn){
    var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
    if (exn.MEL_EXN_ID === A || exn.MEL_EXN_ID === Js__Js_exn.$$Error) {
      a0 = exn._1;
    } else {
      throw new Error("Assert_failure", {
                cause: {
                  MEL_EXN_ID: "Assert_failure",
                  _1: [
                    "x.ml",
                    7,
                    11
                  ]
                }
              });
    }
  }
  
  console.log(a0);
  
  exports.A = A;
  /* a0 Not a pure module */
  $ node _build/default/js-out/x.js
  2

Raise `null` / `undefined`

  $ cat > x.ml << EOF
  > exception A of int
  > let () =
  >   let a0 =
  >     try [%mel.raw{| (function (){throw undefined} ()) |}] with
  >     | A x -> x
  >     | Js.Exn.Error v -> Obj.magic v
  >     | _ -> assert false
  >   and a1 =
  >     try [%mel.raw{| (function (){throw null} ()) |}] with
  >     | A x -> x
  >     | Js.Exn.Error v -> Obj.magic v
  >     | _ -> assert false
  >   in
  >   Js.log2 a0 a1
  > EOF
  $ dune build @melange
  $ cat _build/default/js-out/x.js
  // Generated by Melange
  'use strict';
  
  var Caml_exceptions = require("melange.js/caml_exceptions.js");
  var Caml_js_exceptions = require("melange.js/caml_js_exceptions.js");
  var Js__Js_exn = require("melange.js/js_exn.js");
  
  var A = /* @__PURE__ */Caml_exceptions.create("Melange__X.A");
  
  var a0;
  
  try {
    a0 = ((function (){throw undefined} ())
    );
  }
  catch (raw_exn){
    var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
    if (exn.MEL_EXN_ID === A || exn.MEL_EXN_ID === Js__Js_exn.$$Error) {
      a0 = exn._1;
    } else {
      throw new Error("Assert_failure", {
                cause: {
                  MEL_EXN_ID: "Assert_failure",
                  _1: [
                    "x.ml",
                    7,
                    11
                  ]
                }
              });
    }
  }
  
  var a1;
  
  try {
    a1 = ((function (){throw null} ())
    );
  }
  catch (raw_exn$1){
    var exn$1 = Caml_js_exceptions.internalToOCamlException(raw_exn$1);
    if (exn$1.MEL_EXN_ID === A || exn$1.MEL_EXN_ID === Js__Js_exn.$$Error) {
      a1 = exn$1._1;
    } else {
      throw new Error("Assert_failure", {
                cause: {
                  MEL_EXN_ID: "Assert_failure",
                  _1: [
                    "x.ml",
                    12,
                    11
                  ]
                }
              });
    }
  }
  
  console.log(a0, a1);
  
  exports.A = A;
  /* a0 Not a pure module */
  $ node _build/default/js-out/x.js
  $TESTCASE_ROOT/_build/default/js-out/node_modules/melange.js/caml_js_exceptions.js:11
    if (Js__Caml_exceptions.caml_is_extension(e.cause)) {
                                                ^
  
  TypeError: Cannot read properties of undefined (reading 'cause')
      at Object.internalToOCamlException ($TESTCASE_ROOT/_build/default/js-out/node_modules/melange.js/caml_js_exceptions.js:11:47)
      at Object.<anonymous> ($TESTCASE_ROOT/_build/default/js-out/x.js:17:32)
      at Module._compile (node:internal/modules/cjs/loader:1378:14)
      at Module._extensions..js (node:internal/modules/cjs/loader:1437:10)
      at Module.load (node:internal/modules/cjs/loader:1212:32)
      at Module._load (node:internal/modules/cjs/loader:1028:12)
      at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:142:12)
      at node:internal/main/run_main_module:28:49
  
  Node.js v21.6.1
  [1]
