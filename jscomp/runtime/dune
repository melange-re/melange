(rule
 (deps js.pre.ml)
 (target js.ml)
 (action
  (progn
   (with-stdout-to
    %{target}
    (run awk -f %{dep:expand_module_aliases.awk} %{deps})))))

(library
 (public_name melange.js)
 (name js)
 (modes melange)
 (preprocess
  (pps melange.ppx -unsafe))
 (stdlib
  ; (modules_before_stdlib Js_exn Js_vector Js_array2 Js_undefined Js_json)
  (internal_modules
   Melange_mini_stdlib
   Js_OO
   Caml*
   Curry
   Js_exn
   Js_array2
   Js_vector
   Js_string
   Js_typed_array2))
 (melange.compile_flags
  -bs-no-version-header
  -bs-no-check-div-by-zero
  -bs-cross-module-opt
  -unsafe
  -w
  -61-69))

(rule
 (deps caml_io.cppo.ml)
 (target caml_io.ml)
 (action
  (with-stdout-to
   %{target}
   (run cppo %{env:CPPO_FLAGS=} %{deps} -o %{target}))))

(rule
 (target js_typed_array.ml)
 (deps js_typed_array.cppo.ml)
 (action
  (run cppo %{deps} -o %{target})))

(rule
 (target js_typed_array2.ml)
 (deps js_typed_array2.cppo.ml)
 (action
  (run cppo %{deps} -o %{target})))
